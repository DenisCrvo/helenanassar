document.addEventListener('DOMContentLoaded', () => {
    // URL de ImplantaÃ§Ã£o do Google Apps Script (Backend)
    const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8oX2gPEZk8Z0qdVZPtozFT011ktpacpEKZiBhWE_yUEWI6bSI2KHIy26g3z8CqiD7kA/exec';

    // Elementos da Interface
    // NOTA: Ajustei o seletor para rsvp-btn, que nÃ£o estava no HTML anterior, 
    // mas assumi que Ã© o botÃ£o que abre o formulÃ¡rio.
    const rsvpButton = document.getElementById('rsvp-btn'); 
    const rsvpFormArea = document.getElementById('form-area');
    const rsvpForm = document.getElementById('rsvp-form-submission');
    const formMessage = document.getElementById('form-message');

    // Estado inicial do formulÃ¡rio (escondido)
    if (rsvpFormArea) {
        rsvpFormArea.style.display = 'none';
    }


    // 1. Mostrar/Esconder o FormulÃ¡rio de RSVP ao clicar no botÃ£o CTA
    if (rsvpButton && rsvpFormArea) {
        rsvpButton.addEventListener('click', (event) => {
            event.preventDefault();

            if (rsvpFormArea.style.display === 'none' || rsvpFormArea.style.display === '') {
                rsvpFormArea.style.display = 'block';
                
                // Mude o texto do botÃ£o para indicar que a aÃ§Ã£o foi realizada ou
                // Adicione a classe para escondÃª-lo/desativÃ¡-lo
                rsvpButton.textContent = 'Obrigado(a)! Agora preencha os dados abaixo.';
                rsvpButton.classList.add('cta-hidden'); 
                
                // Rola a tela para o formulÃ¡rio
                rsvpFormArea.scrollIntoView({ behavior: 'smooth' });

            } else {
                rsvpFormArea.scrollIntoView({ behavior: 'smooth' });
            }
        });
    }

    // 2. Envio REAL do FormulÃ¡rio para o Google Sheets
    if (rsvpForm && formMessage) {
        rsvpForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            // 1. Prepara os dados
            const formData = new FormData(rsvpForm);
            // Converte para URLSearchParams, que o Google Apps Script espera no POST
            const data = new URLSearchParams(formData);

            // 2. Feedback visual inicial
            formMessage.style.color = '#797b77'; // Cor de carregamento
            formMessage.textContent = 'Enviando sua confirmaÃ§Ã£o... Por favor, aguarde.';
            
            // Desativa o botÃ£o de envio para evitar cliques duplos
            const submitButton = rsvpForm.querySelector('.submit-button');
            submitButton.disabled = true;

            try {
                // 3. Envio da RequisiÃ§Ã£o
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // NecessÃ¡rio para evitar erros de CORS no GitHub Pages
                    body: data, 
                });

                // 4. Sucesso na comunicaÃ§Ã£o (como usamos 'no-cors', nÃ£o verificamos response.ok)
                
                // Coleta dados para a mensagem de sucesso personalizada (apenas do JS)
                const name = formData.get('name');
                const adults = formData.get('adults');
                const kids = formData.get('kids');

                formMessage.style.color = 'green';
                formMessage.textContent = `ConfirmaÃ§Ã£o de ${adults} adulto(s) e ${kids} crianÃ§a(s) enviada com sucesso para ${name}! Um abraÃ§o!`;
                
                rsvpForm.reset(); // Limpa o formulÃ¡rio

                // 5. Esconde o formulÃ¡rio apÃ³s 5 segundos e reseta o botÃ£o CTA
                setTimeout(() => {
                    if (rsvpFormArea) rsvpFormArea.style.display = 'none';
                    formMessage.textContent = '';
                    if (rsvpButton) {
                        // Texto original do CTA (ajuste para o seu texto real)
                        rsvpButton.textContent = 'ðŸ‘‰ VOU ESCALAR ESTA MONTANHA PARA CELEBRAR! ðŸ‘ˆ'; 
                        rsvpButton.classList.remove('cta-hidden');
                    }
                }, 5000);

            } catch (error) {
                // 6. Trata Erros de Rede ou Script (Raramente ocorre com no-cors, mas Ã© bom ter)
                console.error('Erro de envio:', error);
                formMessage.style.color = 'red';
                formMessage.textContent = 'Falha ao enviar a confirmaÃ§Ã£o. Por favor, verifique sua conexÃ£o e tente novamente.';
            } finally {
                // 7. Reativa o botÃ£o de envio
                submitButton.disabled = false;
            }
        });
    }
});